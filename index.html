<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Celencia — Repo Index</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#1b1711;           /* tavern walls */
      --paper:#efe6ce;        /* parchment */
      --ink:#2b2b2b;          /* ink */
      --ink-soft:#5c5648;
      --edge:#d2c7a3;         /* deckled edge */
      --gold:#d6a645;         /* accent */
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);font:14px/1.5 Inter,system-ui,sans-serif;color:var(--paper)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:18px 20px;border-bottom:1px solid #2a241a;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(0,0,0,.1))}
    h1{margin:0;font:700 28px/1.1 Cinzel,serif;letter-spacing:.5px}
    .wrap{max-width:1200px;margin:20px auto 60px;padding:0 16px}
    .btn{border:1px solid var(--edge);background:rgba(239,230,206,.08);color:var(--paper);border-radius:10px;padding:9px 12px;cursor:pointer}
    .btn:hover{background:rgba(239,230,206,.15)}
    .panel{background:radial-gradient(1200px 300px at -10% -10%,rgba(255,255,255,.06),transparent),
                   radial-gradient(800px 300px at 110% 0%,rgba(255,255,255,.04),transparent),
                   var(--paper);
           color:var(--ink);border:1px solid var(--edge);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
    .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px dashed var(--edge)}
    .bd{padding:12px 14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="text"]{width:100%;max-width:520px;padding:10px;border:1px solid var(--edge);border-radius:10px;background:rgba(239,230,206,.3);color:var(--ink)}
    details{border:1px dashed var(--edge);border-radius:10px;margin:8px 0;background:rgba(239,230,206,.55)}
    details>summary{cursor:pointer;padding:8px 12px;font:700 14px Cinzel,serif;color:#5e4a2e}
    details>summary::-webkit-details-marker{display:none}
    ul.files{margin:0 0 8px 18px;padding:0}
    ul.files li{list-style:none;padding:6px 8px;border-bottom:1px dashed var(--edge);display:flex;gap:10px;align-items:center}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    a{color:#0a58a6;text-decoration:none}
    a:hover{text-decoration:underline}
    .links a{margin-right:8px}
    .pill{display:inline-block;border:1px solid var(--edge);border-radius:999px;padding:2px 8px;margin:2px 6px 0 0;color:#664f23;background:rgba(214,166,69,.18)}
  </style>
</head>
<body>
  <header>
    <h1>Celencia • Repo Index</h1>
    <div class="row">
      <button id="expandAll" class="btn">Expand all</button>
      <button id="collapseAll" class="btn">Collapse all</button>
      <button id="downloadJSON" class="btn">Download index.json</button>
    </div>
  </header>
  <div class="wrap">
    <section class="panel">
      <div class="hd">
        <strong class="mono">Find a scroll</strong>
        <span style="color:var(--ink-soft)">live from the repository</span>
      </div>
      <div class="bd">
        <div class="row" style="margin-bottom:8px">
          <input id="q" type="text" placeholder="Filter paths (e.g. Celencia/, .html, Session)"/>
        </div>
        <div id="tree"></div>
      </div>
    </section>
  </div>

<script>
const owner='ProfCory';
const repo='Celencia';
const ref='main';

const state={ rows:[], q:'' };

function toBlob(p){return `https://github.com/${owner}/${repo}/blob/${ref}/${p}`}
function toRaw(p){return `https://raw.githubusercontent.com/${owner}/${repo}/${ref}/${p}`}
function toPage(p){return p} // relative link for GitHub Pages

async function fetchTree(){
  const url=`https://api.github.com/repos/${owner}/${repo}/git/trees/${ref}?recursive=1`;
  const res=await fetch(url);
  if(!res.ok){ document.getElementById('tree').textContent='Failed to load repository tree.'; return; }
  const json=await res.json();
  state.rows=(json.tree||[]).filter(n=>n.type==='blob');
  render();
}

function buildHierarchy(files){
  const root={folders:new Map(), files:[]};
  for(const f of files){
    const parts=f.path.split('/');
    let cur=root;
    for(let i=0;i<parts.length-1;i++){
      const seg=parts[i];
      if(!cur.folders.has(seg)) cur.folders.set(seg,{folders:new Map(),files:[],name:seg});
      cur=cur.folders.get(seg);
    }
    cur.files.push({path:f.path,size:f.size||0,name:parts.at(-1)});
  }
  return root;
}

function render(){
  const q=(state.q||'').toLowerCase();
  const tree=buildHierarchy(state.rows);
  const el=document.getElementById('tree');
  el.innerHTML='';

  // render child folders
  for(const [name,node] of tree.folders){ el.appendChild(renderFolder(node,q)); }
  // render root files
  if(tree.files.length){ const d=document.createElement('details'); d.open=true; d.innerHTML=`<summary>/ (root)</summary>`; d.appendChild(renderFiles(tree.files,q)); el.appendChild(d); }
}

function renderFolder(node,q){
  const d=document.createElement('details');
  d.innerHTML=`<summary>${node.name}</summary>`;
  for(const [name,child] of node.folders){ d.appendChild(renderFolder(child,q)); }
  d.appendChild(renderFiles(node.files,q));
  if(q && folderHasMatch(node,q)) d.open=true;
  return d;
}

function folderHasMatch(node,q){
  if(node.files.some(f=>f.path.toLowerCase().includes(q))) return true;
  for(const ch of node.folders.values()) if(folderHasMatch(ch,q)) return true;
  return false;
}

function renderFiles(list,q){
  const ul=document.createElement('ul'); ul.className='files';
  for(const f of list){
    if(q && !f.path.toLowerCase().includes(q)) continue;
    const ext=(f.name.match(/\.([a-z0-9]+)$/i)||[])[1]?.toLowerCase();
    const isHTML=ext==='html';
    const li=document.createElement('li');
    li.innerHTML=`
      <span class="mono">${f.name}</span>
      <span class="pill">${fmtSize(f.size)}</span>
      <span class="links">${isHTML?`<a href="${toPage(f.path)}" target="_blank" rel="noopener">open</a>`:''}
        <a href="${toBlob(f.path)}" target="_blank" rel="noopener">blob</a>
        <a href="${toRaw(f.path)}" target="_blank" rel="noopener">raw</a></span>`;
    ul.appendChild(li);
  }
  return ul;
}

function fmtSize(n){ if(!n) return ''; const u=['B','KB','MB','GB']; let i=0,v=n; while(v>1024&&i<u.length-1){v/=1024;i++} return (v<10?v.toFixed(1):Math.round(v))+" "+u[i]; }

// Controls
const qEl=document.getElementById('q');
qEl.addEventListener('input',()=>{ state.q=qEl.value.trim(); render(); });

document.getElementById('expandAll').onclick=()=>{ document.querySelectorAll('#tree details').forEach(d=>d.open=true); };
document.getElementById('collapseAll').onclick=()=>{ document.querySelectorAll('#tree details').forEach(d=>d.open=false); };

document.getElementById('downloadJSON').onclick=()=>{
  const blob=new Blob([JSON.stringify(state.rows,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='repo_index.json'; a.click(); URL.revokeObjectURL(a.href);
};

fetchTree();
</script>
</body>
</html>
